# Mock Exam 1 - Question 5

## Question 5: Blue/Green Deployment

In this task, we have to create two identical environments that are running different versions of the application. The team decided to use the Blue/green deployment method to deploy a total of 10 application pods which can mitigate common risks such as downtime and rollback capability.

Also, we have to route traffic in such a way that 30% of the traffic is sent to the green-apd environment and the rest is sent to the blue-apd environment. All the development processes will happen on cluster 3 because it has enough resources for scalability and utility consumption.

### Blue-APD Deployment Specifications:

- The name of the deployment is `blue-apd`
- Use the label `type-one: blue`
- Use the image `kodekloud/webapp-color:v1`
- Add labels to the pod `type-one: blue` and `version: v1`

### Green-APD Deployment Specifications:

- The name of the deployment is `green-apd`
- Use the label `type-two: green`
- Use the image `kodekloud/webapp-color:v2`
- Add labels to the pod `type-two: green` and `version: v1`

### Service Specifications:

We have to create a service called `route-apd-svc` for these deployments. Details are here:

- The name of the service is `route-apd-svc`
- Use the correct service type to access the application from outside the cluster and application should listen on port 8080
- Use the selector label `version: v1`

> **NOTE**: We do not need to increase replicas for the deployments, and all the resources should be created in the default namespace.

### Solution:

**blue-green-deployment.yaml**

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: blue-apd
  namespace: default
  labels:
    type-one: blue
spec:
  replicas: 5
  selector:
    matchLabels:
      type-one: blue
  template:
    metadata:
      labels:
        type-one: blue
        version: v1
    spec:
      containers:
      - name: webapp-color-v1
        image: kodekloud/webapp-color:v1
        ports:
        - containerPort: 8080

---

apiVersion: apps/v1
kind: Deployment
metadata:
  name: green-apd
  namespace: default
  labels:
    type-two: green
spec:
  replicas: 5
  selector:
    matchLabels:
      type-two: green
  template:
    metadata:
      labels:
        type-two: green
        version: v1
    spec:
      containers:
      - name: webapp-color-v2
        image: kodekloud/webapp-color:v2
        ports:
        - containerPort: 8080

---

apiVersion: v1
kind: Service
metadata:
  name: route-apd-svc
  namespace: default
spec:
  # Use NodePort to expose the service outside the cluster
  type: NodePort
  selector:
    # This selector targets pods from BOTH deployments
    version: v1
  ports:
  - protocol: TCP
    # Port on which the service is exposed
    port: 8080
    # Port on the pods to which traffic is sent
    targetPort: 8080
```

### Apply the configuration:

```bash
root@student-node ~ ➜  k apply -f blue-apd.yaml 
deployment.apps/blue-apd created
deployment.apps/green-apd created
service/route-apd-svc created

root@student-node ~ ➜  kubectl get deployment blue-apd green-apd
NAME        READY   UP-TO-DATE   AVAILABLE   AGE
blue-apd    0/10    10           0           7s
green-apd   0/1     1            0           7s
```

### Imperative Commands Alternative:

```bash
k create deployment blue-apd --image=kodekloud/webapp-color:v1 --replicas=7 --dry-run=client -o yaml > blue.yaml

k expose deployment blue-apd --name=route-apd-svc --type=NodePort --port=8080 --selector=version=v1

kubectl get pods -l version=v1 -o wide

kubectl get svc route-apd-svc -o yaml
```
